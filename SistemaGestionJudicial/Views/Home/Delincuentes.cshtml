@* Ruta: SistemaGestionJudicial/Views/Home/Delincuentes.cshtml *@
@model List<SistemaGestionJudicial.Models.Persona>

@{
    ViewData["Title"] = "Delincuentes";
    var requestToken = Html.AntiForgeryToken();
}

@section Styles {
    <link rel="stylesheet" href="~/css/delincuentes.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        /* Estilos básicos para el acordeón de juicios */
        .accordion-header {
            background-color: #f3f4f6; /* bg-gray-100 */
            padding: 0.75rem 1rem;
            border-radius: 0.5rem; /* rounded-lg */
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600; /* font-semibold */
            color: #4b5563; /* text-gray-700 */
            transition: background-color 0.2s ease;
        }

            .accordion-header:hover {
                background-color: #e5e7eb; /* hover:bg-gray-200 */
            }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
            padding: 0 1rem; /* Padding horizontal inicial */
            border-left: 2px solid #d1d5db; /* border-gray-300 */
            margin-left: 0.75rem; /* ml-3 */
            background-color: #ffffff; /* bg-white */
            border-radius: 0.5rem; /* rounded-lg */
        }

            .accordion-content.active {
                max-height: 500px; /* Suficientemente grande para el contenido */
                padding: 1rem; /* Padding cuando está activo */
                box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
            }

        /* Estilo para las sentencias dentro del acordeón (ahora no se usarán, pero se mantienen para referencia) */
        .sentencia-item {
            border-left: 2px solid #a7f3d0; /* border-green-300 */
            padding-left: 0.75rem;
            margin-bottom: 0.5rem;
            background-color: #f7fee7; /* bg-green-50 */
            border-radius: 0.25rem;
            padding: 0.5rem;
        }

        /* Ajuste para el modal de añadir delincuente */
        #add-offender-modal .modal-content {
            max-height: 90vh; /* Permite que el modal ocupe hasta el 90% de la altura de la ventana */
            overflow-y: auto; /* Habilita el scroll vertical si el contenido excede el max-height */
            width: 95%; /* Asegura que no sea demasiado angosto en pantallas grandes */
            max-width: 600px; /* Un poco más ancho para mejor distribución de campos */
        }
    </style>
}

<div class="flex h-screen overflow-hidden">
    <div class="flex-1 overflow-auto">
        <header class="bg-white shadow-sm py-4 px-6 flex justify-between items-center no-print">
            <h2 class="text-xl font-semibold text-gray-800" id="view-title">Gestión de Delincuentes</h2>
            <div class="flex items-center space-x-4">
                <div class="relative">
                    @* Campo de búsqueda para filtrar la tabla *@
                    <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="Buscar por cédula, nombre, género..."
                           class="pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="h-8 w-8 rounded-full bg-blue-500 flex items-center justify-center text-white">
                        <i class="fas fa-user"></i>
                    </div>
                    <span class="text-sm font-medium">Admin</span>
                </div>
            </div>
        </header>

        <div class="p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Listado de Delincuentes</h2>
                <button onclick="openAddModal()"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center">
                    <i class="fas fa-plus mr-2"></i> Añadir Delincuente
                </button>
            </div>

            <div class="card bg-white rounded-lg p-6">
                <div class="overflow-x-auto">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Cédula</th>
                                <th>Nombre Completo</th>
                                <th>Fecha Nacimiento</th>
                                <th>Género</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="delincuentesTableBody">
                            @if (Model != null && Model.Any())
                            {
                                foreach (var persona in Model)
                                {
                                    <tr>
                                        <td>@persona.IdPersona</td>
                                        <td>@persona.Cedula</td>
                                        <td>@($"{persona.Nombres} {persona.Apellidos}")</td>
                                        <td>@(persona.FechaNacimiento?.ToShortDateString() ?? "N/A")</td>
                                        <td>@(persona.Genero == "M" ? "Masculino" : (persona.Genero == "F" ? "Femenino" : "Otro"))</td>
                                        <td>
                                            <button class="text-blue-600 hover:text-blue-800 mr-2"
                                                    onclick="fetchAndOpenDetailModal(@persona.IdPersona)">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            @* El botón de Eliminar ha sido quitado aquí *@
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="6" class="text-center py-4">No se encontraron delincuentes con IdRol = 3.</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@* MODAL DE DETALLES *@
<div id="offender-detail-modal"
     class="modal hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center z-50">
    <div class="modal-content bg-white rounded-lg p-6 w-full max-w-2xl overflow-y-auto max-h-[90vh]">
        <h3 class="text-lg font-bold mb-4">Detalles del Delincuente</h3>
        <div class="flex flex-col md:flex-row gap-6">
            <div class="w-full md:w-1/3">
                <div class="bg-gray-100 rounded-lg overflow-hidden mb-2">
                    <img id="detail-image" src="https://randomuser.me/api/portraits/lego/1.jpg"
                         class="w-full h-auto object-cover">
                </div>
            </div>
            <div class="w-full md:w-2/3" id="offender-details">
                <p><strong>ID:</strong> <span id="detail-id"></span></p>
                <p><strong>Cédula:</strong> <span id="detail-cedula"></span></p>
                <p><strong>Nombre:</strong> <span id="detail-name"></span></p>
                <p><strong>Fecha Nacimiento:</strong> <span id="detail-dob"></span></p>
                <p><strong>Género:</strong> <span id="detail-gender"></span></p>
                <p><strong>Dirección:</strong> <span id="detail-direccion"></span></p>
                <p><strong>Teléfono:</strong> <span id="detail-telefono"></span></p>
                <p><strong>Correo:</strong> <span id="detail-correo"></span></p>
            </div>
        </div>

        <div class="mt-6">
            <h4 class="text-xl font-bold mb-3 text-gray-800">Juicios Asociados:</h4>
            <div id="detail-juicios">
            </div>
        </div>

        <div class="flex justify-end mt-4">
            <button type="button" class="bg-gray-500 text-white px-4 py-2 rounded-lg"
                    onclick="closeModal('offender-detail-modal')">
                Cerrar
            </button>
        </div>
    </div>
</div>

@* MODAL PARA AÑADIR DELINCUENTE (AJUSTADO) *@
<div id="add-offender-modal"
     class="modal hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center z-50">
    <div class="modal-content bg-white rounded-lg p-6 w-full max-w-md">
        @* Se ajustará el max-width y se añadirá el overflow-y en el style *@
        <h3 class="text-lg font-bold mb-4">Añadir Nuevo Delincuente</h3>
        <form id="addDelincuenteForm" method="post" action="/Delincuentes/Create">
            @requestToken
            <div class="mb-4">
                <label for="addNombres" class="block text-gray-700 text-sm font-bold mb-2">Nombres:</label>
                <input type="text" id="addNombres" name="Nombres" required
                       class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>
            <div class="mb-4">
                <label for="addApellidos" class="block text-gray-700 text-sm font-bold mb-2">Apellidos:</label>
                <input type="text" id="addApellidos" name="Apellidos" required
                       class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>
            <div class="mb-4">
                <label for="addFechaNacimiento" class="block text-gray-700 text-sm font-bold mb-2">Fecha Nacimiento:</label>
                <input type="date" id="addFechaNacimiento" name="FechaNacimiento"
                       class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>
            <div class="mb-4">
                <label for="addGenero" class="block text-gray-700 text-sm font-bold mb-2">Género:</label>
                <select id="addGenero" name="Genero"
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    <option value="">Seleccione</option>
                    <option value="M">Masculino</option>
                    <option value="F">Femenino</option>
                    <option value="O">Otro</option>
                </select>
            </div>
            <div class="mb-4">
                <label for="addCedula" class="block text-gray-700 text-sm font-bold mb-2">Cédula:</label>
                <input type="text" id="addCedula" name="Cedula" required
                       class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>
            <div class="mb-4">
                <label for="addDireccion" class="block text-gray-700 text-sm font-bold mb-2">Dirección:</label>
                <input type="text" id="addDireccion" name="Direccion"
                       class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>
            <div class="mb-4">
                <label for="addTelefono" class="block text-gray-700 text-sm font-bold mb-2">Teléfono:</label>
                <input type="text" id="addTelefono" name="Telefono"
                       class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>
            <div class="mb-4">
                <label for="addCorreoElectronico" class="block text-gray-700 text-sm font-bold mb-2">Correo Electrónico:</label>
                <input type="email" id="addCorreoElectronico" name="CorreoElectronico"
                       class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>

            <div class="flex items-center justify-between">
                <button type="button" class="bg-gray-500 text-white px-4 py-2 rounded-lg"
                        onclick="closeModal('add-offender-modal')">
                    Cancelar
                </button>
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                    Guardar Delincuente
                </button>
            </div>
        </form>
    </div>
</div>

@* El MODAL DE CONFIRMACIÓN DE ELIMINACIÓN ha sido ELIMINADO *@


<script>
    const antiForgeryToken = '@requestToken.ToString().Replace("\"", "'")';
    const antiForgeryHeaderName = antiForgeryToken.split('=')[0].replace('<input name=', '').replace('type=\'hidden\' value=\'', '').replace('\' />', '').trim();
    const antiForgeryTokenValue = antiForgeryToken.split('value=\'')[1].replace('\' />', '').trim();

    function openModal(modalId) {
        document.getElementById(modalId).classList.remove('hidden');
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.add('hidden');
    }

    // --- FUNCIONALIDAD PARA AÑADIR DELINCUENTE ---
    function openAddModal() {
        document.getElementById('addDelincuenteForm').reset();
        openModal('add-offender-modal');
    }

    document.getElementById('addDelincuenteForm').addEventListener('submit', async function (event) {
        event.preventDefault();

        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());
        data[antiForgeryHeaderName] = antiForgeryTokenValue;

        try {
            const response = await fetch(this.action, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [antiForgeryHeaderName]: antiForgeryTokenValue
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
                alert(result.message);
                closeModal('add-offender-modal');
                window.location.reload(); // Recargar la página para ver el cambio
            } else {
                alert(`Error: ${result.message}\n${(result.errors ? result.errors.join('\n') : '')}`);
            }
        } catch (error) {
            console.error('Error al añadir delincuente:', error);
            alert('Error al añadir delincuente. Intente de nuevo.');
        }
    });

    // --- FUNCIONALIDAD PARA FILTRAR LA TABLA ---
    function filterTable() {
        const input = document.getElementById('searchInput');
        const filter = input.value.toLowerCase();
        const tableBody = document.getElementById('delincuentesTableBody');
        const trs = tableBody.getElementsByTagName('tr');

        for (let i = 0; i < trs.length; i++) {
            let found = false;
            const cedulaTd = trs[i].getElementsByTagName('td')[1]; // Cédula
            const nombreCompletoTd = trs[i].getElementsByTagName('td')[2]; // Nombre Completo
            const generoTd = trs[i].getElementsByTagName('td')[4]; // Género

            if (cedulaTd && cedulaTd.textContent.toLowerCase().includes(filter)) {
                found = true;
            }
            if (nombreCompletoTd && nombreCompletoTd.textContent.toLowerCase().includes(filter)) {
                found = true;
            }
            if (generoTd && generoTd.textContent.toLowerCase().includes(filter)) {
                const generoText = generoTd.textContent.toLowerCase();
                if (generoText.includes(filter) ||
                    (filter === 'm' && generoText.includes('masculino')) ||
                    (filter === 'f' && generoText.includes('femenino')) ||
                    (filter === 'o' && generoText.includes('otro'))
                ) {
                    found = true;
                }
            }

            if (found) {
                trs[i].style.display = '';
            } else {
                trs[i].style.display = 'none';
            }
        }
    }

    // --- FUNCIONALIDAD PARA ELIMINAR DELINCUENTE (FUNCIONES ELIMINADAS) ---
    // confirmDelete y deleteDelincuente han sido eliminadas ya que no se usarán.

    // --- FUNCIONALIDAD PARA VER DETALLES ---
    async function fetchAndOpenDetailModal(id) {
        try {
            const response = await fetch(`/Delincuentes/GetDelincuenteDetails/${id}`);
            if (!response.ok) {
                alert('Error al obtener los detalles del delincuente.');
                return;
            }
            const persona = await response.json();

            document.getElementById('detail-id').innerText = persona.id;
            document.getElementById('detail-cedula').innerText = persona.cedula;
            document.getElementById('detail-name').innerText = `${persona.nombres} ${persona.apellidos}`;
            document.getElementById('detail-dob').innerText = persona.fechaNacimiento || 'N/A';
            document.getElementById('detail-gender').innerText = persona.genero === "M" ? "Masculino" : (persona.genero === "F" ? "Femenino" : "Otro");
            document.getElementById('detail-direccion').innerText = persona.direccion || 'N/A';
            document.getElementById('detail-telefono').innerText = persona.telefono || 'N/A';
            document.getElementById('detail-correo').innerText = persona.correoElectronico || 'N/A';

            document.getElementById('detail-image').src = `https://randomuser.me/api/portraits/${persona.genero === 'M' ? 'men' : 'women'}/${persona.id % 99}.jpg`;

            const juiciosContainer = document.getElementById('detail-juicios');
            juiciosContainer.innerHTML = '';

            if (persona.juiciosYDelitos && persona.juiciosYDelitos.length > 0) {
                persona.juiciosYDelitos.forEach((item, index) => {
                    const juicioDiv = document.createElement('div');
                    juicioDiv.classList.add('mb-3');

                    const header = document.createElement('div');
                    header.classList.add('accordion-header', 'mb-2');
                    header.innerHTML = `
                        <span>Juicio #${item.idJuicio} - ${item.estadoJuicio || 'N/A'} (Delito: ${item.nombreDelito || 'Sin Especificar'})</span>
                        <i class="fas fa-chevron-down ml-2"></i>
                    `;
                    header.onclick = () => {
                        const content = juicioDiv.querySelector('.accordion-content');
                        content.classList.toggle('active');
                        const icon = header.querySelector('i');
                        icon.classList.toggle('fa-chevron-down');
                        icon.classList.toggle('fa-chevron-up');
                    };

                    const content = document.createElement('div');
                    content.classList.add('accordion-content');
                    content.innerHTML = `
                        <p class="mb-1"><strong>ID Juicio Acusado:</strong> ${item.idJuicioAcusado || 'N/A'}</p>
                        <p class="mb-1"><strong>Estado:</strong> ${item.estadoJuicio || 'N/A'}</p>
                        <p class="mb-1"><strong>Inicio:</strong> ${item.fechaInicioJuicio || 'N/A'}</p>
                        <p class="mb-1"><strong>Fin:</strong> ${item.fechaFinJuicio || 'N/A'}</p>

                        <h5 class="text-sm font-semibold mt-3 mb-1 text-gray-700">Detalles del Delito:</h5>
                        <div class="ml-4 border-l-2 border-gray-200 pl-3 py-1 mb-2">
                            <p class="mb-1"><strong>Nombre:</strong> ${item.nombreDelito || 'N/A'}</p>
                            <p class="mb-1"><strong>Tipo:</strong> ${item.tipoDelito || 'N/A'}</p>
                            <p class="mb-1"><strong>Gravedad:</strong> ${item.gravedadDelito || 'N/A'}</p>
                            <p class="mb-1"><strong>Descripción:</strong> ${item.descripcionDelito || 'N/A'}</p>
                        </div>
                        <p class="text-gray-500 italic mt-3">La información de sentencias no está disponible temporalmente.</p>
                    `;

                    juicioDiv.appendChild(header);
                    juicioDiv.appendChild(content);
                    juiciosContainer.appendChild(juicioDiv);
                });
            } else {
                juiciosContainer.innerHTML = '<p class="text-gray-500 italic">No hay juicios asociados a este delincuente.</p>';
            }

            openModal('offender-detail-modal');

        } catch (error) {
            console.error('Error al obtener detalles del delincuente:', error);
            alert('No se pudo cargar los detalles del delincuente.');
        }
    }
</script>