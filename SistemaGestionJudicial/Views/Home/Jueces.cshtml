@model IEnumerable<SistemaGestionJudicial.Models.Persona>
@{
    ViewData["Title"] = "Gestión de Jueces";
}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>@ViewData["Title"]</title>

    <!-- 1) jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- 2) jQuery Validate -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
    <!-- 3) Unobtrusive Validation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validation-unobtrusive/3.2.12/jquery.validate.unobtrusive.min.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        .modal {
            z-index: 50;
        }

            .modal.hidden {
                display: none;
            }

        .data-table th, .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .data-table th {
            background-color: #1e40af;
            color: white;
            font-weight: 600;
        }

        .data-table tr:hover {
            background-color: #f8fafc;
        }

        .form-input {
            border: 1px solid #d1d5db;
            border-radius: .375rem;
            padding: .5rem .75rem;
            width: 100%;
        }

        .scroll-btn {
            position: fixed;
            right: 30px;
            bottom: 30px;
            z-index: 100;
            display: none;
            background: #1e40af;
            color: white;
            padding: 12px 16px;
            border-radius: 9999px;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body class="min-h-screen relative">

    <!-- Fondo -->
    <div class="absolute inset-0 -z-10 bg-cover bg-center"
         style="background-image: url('/img/greco_roman_court.png');"></div>

    <!-- MODAL ERROR TempData -->
    @if (TempData["ErrorMensaje"] != null)
    {
        <div id="error-modal"
             class="modal fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center z-50">
            <div class="modal-content bg-white rounded-lg p-6 w-96">
                <h3 class="text-lg font-bold mb-4 text-red-700">Error</h3>
                <p class="mb-4 text-gray-700">@TempData["ErrorMensaje"]</p>
                <div class="flex justify-end">
                    <button type="button"
                            onclick="closeModal('error-modal')"
                            class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg mr-2">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
        <script>
            setTimeout(function(){ closeModal('error-modal'); },5000);
        </script>
    }

    <!-- Abrir modal si ModelState inválido -->
    @if (!ViewData.ModelState.IsValid || ViewBag.OpenCreateModal == true)
    {
        <script>
            window.onload = function() {
                openModal('add-judge-modal');
            }
        </script>
    }
    else if (ViewBag.OpenEditModal == true)
    {
        <script>
            window.onload = function() {
                openModal('edit-judge-modal');
            }
        </script>
    }

    <div class="relative p-6">
        <h2 class="text-2xl font-bold mb-4">Gestión de Jueces</h2>
        <button onclick="openModal('add-judge-modal')"
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center mb-6">
            <i class="fas fa-plus mr-2"></i> Añadir Juez
        </button>

        <div class="card bg-white bg-opacity-75 rounded-lg p-6 overflow-x-auto">
            <table class="data-table w-full" id="judgesTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre Completo</th>
                        <th>Cédula</th>
                        <th>Correo</th>
                        <th>Teléfono</th>
                        <th>Género</th>
                        <th>Dirección</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    @if (Model != null && Model.Any())
                    {
                        var row = 0;
                        foreach (var judge in Model)
                        {
                            <tr data-row="@row">
                                <td>@judge.IdPersona</td>
                                <td>@judge.Nombres @judge.Apellidos</td>
                                <td>@judge.Cedula</td>
                                <td>@judge.CorreoElectronico</td>
                                <td>@judge.Telefono</td>
                                <td>@judge.Genero</td>
                                <td>@judge.Direccion</td>
                                <td>
                                    <button class="text-blue-600 hover:text-blue-800 mr-2"
                                            onclick="openDetailModal(
                                                '@judge.IdPersona',
                                                '@judge.Cedula',
                                                '@judge.Nombres',
                                                '@judge.Apellidos',
                                                '@(judge.FechaNacimiento?.ToString("yyyy-MM-dd")??"")',
                                                '@judge.Genero',
                                                '@judge.Direccion',
                                                '@judge.Telefono',
                                                '@judge.CorreoElectronico')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="text-green-600 hover:text-green-800 mr-2"
                                            onclick="openEditModal(
                                                '@judge.IdPersona',
                                                '@judge.Cedula',
                                                '@judge.Nombres',
                                                '@judge.Apellidos',
                                                '@(judge.FechaNacimiento?.ToString("yyyy-MM-dd")??"")',
                                                '@judge.Genero',
                                                '@judge.Direccion',
                                                '@judge.Telefono',
                                                '@judge.CorreoElectronico')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="text-red-600 hover:text-red-800"
                                            onclick="openDeleteModal(
                                                '@judge.IdPersona',
                                                '@judge.Nombres @judge.Apellidos')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            row++;
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="8" class="text-center text-gray-500 py-4">
                                No existen jueces registrados.
                            </td>
                        </tr>
                    }
                </tbody>
            </table>

            <!-- Paginación -->
            <div class="flex justify-between items-center mt-4" id="paginationControls">
                <button onclick="changePage(-1)" id="prevBtn"
                        class="bg-gray-200 text-gray-700 px-3 py-1 rounded mr-2" disabled>
                    Anterior
                </button>
                <span id="pageInfo"></span>
                <button onclick="changePage(1)" id="nextBtn"
                        class="bg-gray-200 text-gray-700 px-3 py-1 rounded ml-2">
                    Siguiente
                </button>
                <div class="inline-block ml-auto">
                    <label for="rowsPerPage" class="block text-sm">Mostrar</label>
                    <select id="rowsPerPage" class="form-input w-20" onchange="changeRowsPerPage()">
                        <option value="5">5</option>
                        <option value="10" selected>10</option>
                        <option value="25">25</option>
                        <option value="all">Todos</option>
                    </select>
                    <span class="block text-xs mt-1">por página</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Detalle Modal -->
    <div id="judge-detail-modal"
         class="modal hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center">
        <div class="modal-content bg-white rounded-lg p-6 w-full max-w-3xl">
            <h3 class="text-lg text-center text-blue-600 font-bold mb-4">Detalles del Juez</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label>Cédula</label><p id="det-cedula" class="form-input"></p></div>
                <div><label>Nombres</label><p id="det-nombres" class="form-input"></p></div>
                <div><label>Apellidos</label><p id="det-apellidos" class="form-input"></p></div>
                <div><label>Fecha de nacimiento</label><p id="det-fecha" class="form-input"></p></div>
                <div><label>Género</label><p id="det-genero" class="form-input"></p></div>
                <div><label>Dirección</label><p id="det-direccion" class="form-input"></p></div>
                <div><label>Teléfono</label><p id="det-telefono" class="form-input"></p></div>
                <div><label>Correo electrónico</label><p id="det-correo" class="form-input"></p></div>
            </div>
            <div class="flex justify-center mt-6">
                <button onclick="closeModal('judge-detail-modal')"
                        class="bg-gray-500 text-white px-4 py-2 rounded-lg">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Añadir Modal -->
    <div id="add-judge-modal"
         class="modal hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center">
        <div class="modal-content bg-white rounded-lg p-6 w-96">
            <h3 class="text-lg font-bold mb-4">Añadir Juez</h3>
            <form id="addForm" asp-action="CreateJuez" asp-controller="Jueces" method="post" novalidate>
                @Html.AntiForgeryToken()
                <div class="mb-4">
                    <label>Cédula</label>
                    <input id="addCedula" name="Cedula" class="form-input" maxlength="10" required />
                </div>
                <div class="mb-4">
                    <label>Nombres</label>
                    <input id="addNombres" name="Nombres" class="form-input" maxlength="100" required />
                </div>
                <div class="mb-4">
                    <label>Apellidos</label>
                    <input id="addApellidos" name="Apellidos" class="form-input" maxlength="100" required />
                </div>
                <div class="mb-4">
                    <label>Fecha de nacimiento</label>
                    <input id="addFecha" name="FechaNacimiento" type="date" class="form-input" required />
                </div>
                <div class="mb-4">
                    <label>Género</label>
                    <select id="addGenero" name="Genero" class="form-input" required>
                        <option value="">Seleccionar</option>
                        <option value="M">Masculino</option>
                        <option value="F">Femenino</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label>Dirección</label>
                    <input id="addDireccion" name="Direccion" class="form-input" maxlength="200" required />
                </div>
                <div class="mb-4">
                    <label>Teléfono</label>
                    <input id="addTelefono" name="Telefono" class="form-input" maxlength="20" required />
                </div>
                <div class="mb-4">
                    <label>Correo electrónico</label>
                    <input id="addCorreoElectronico" name="CorreoElectronico"
                           type="email" class="form-input" maxlength="200" required />
                </div>
                <div class="flex justify-end">
                    <button type="button" onclick="closeModal('add-judge-modal')"
                            class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg mr-2">
                        Cancelar
                    </button>
                    <button type="submit"
                            class="bg-blue-600 text-white px-4 py-2 rounded-lg">
                        Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Editar Modal -->
    <div id="edit-judge-modal" class="modal hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center">
        <div class="modal-content bg-white rounded-lg p-6 w-96">
            <h3 class="text-lg font-bold mb-4">Editar Juez</h3>
            <form id="editForm" asp-action="Edit" asp-controller="Jueces" method="post" novalidate>
                @Html.AntiForgeryToken()
                <input type="hidden" name="IdPersona" id="editIdPersona" />

                <div class="mb-4">
                    <label>Cédula</label>
                    <input name="Cedula" id="editCedula" class="form-input" maxlength="10" required />
                </div>
                <div class="mb-4">
                    <label>Nombres</label>
                    <input name="Nombres" id="editNombres" class="form-input" maxlength="100" required />
                </div>
                <div class="mb-4">
                    <label>Apellidos</label>
                    <input name="Apellidos" id="editApellidos" class="form-input" maxlength="100" required />
                </div>
                <div class="mb-4">
                    <label>Fecha de nacimiento</label>
                    <input name="FechaNacimiento" id="editFechaNacimiento" type="date" class="form-input" required />
                </div>
                <div class="mb-4">
                    <label>Género</label>
                    <select name="Genero" id="editGenero" class="form-input" required>
                        <option value="">Seleccionar</option>
                        <option value="M">Masculino</option>
                        <option value="F">Femenino</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label>Dirección</label>
                    <input name="Direccion" id="editDireccion" class="form-input" maxlength="200" required />
                </div>
                <div class="mb-4">
                    <label>Teléfono</label>
                    <input name="Telefono" id="editTelefono" class="form-input" maxlength="20" required />
                </div>
                <div class="mb-4">
                    <label>Correo electrónico</label>
                    <input name="CorreoElectronico" id="editCorreoElectronico" type="email" class="form-input" maxlength="200" required />
                </div>

                <div class="flex justify-end">
                    <button type="button" onclick="closeModal('edit-judge-modal')" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg mr-2">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        console.log('jQuery version:', $.fn.jquery, 'validate:', typeof $.fn.validate);
        if (typeof $.fn.validate !== 'function') console.warn('jQuery Validate NO está cargado');
        else {
          $('#editForm').validate({
            errorClass: 'text-red-600 text-xs mt-1',
            errorElement: 'span',
            highlight: e => $(e).addClass('border-red-500'),
            unhighlight: e => $(e).removeClass('border-red-500'),
            errorPlacement: (err, el) => err.insertAfter(el),
            submitHandler: form => form.submit()
          });
        }
    </script>

    <!-- Eliminar Modal -->
    <div id="delete-judge-modal"
         class="modal hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center">
        <div class="modal-content bg-white rounded-lg p-6 w-96">
            <h3 class="text-lg font-bold mb-4">Eliminar Juez</h3>
            <form id="deleteJudgeForm" asp-action="Delete" asp-controller="Jueces" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="IdPersona" id="deleteIdPersona" />
                <p class="mb-4">
                    ¿Seguro que deseas eliminar al juez
                    <span id="deleteJudgeName" class="font-bold"></span>?
                </p>
                <div class="flex justify-end">
                    <button type="button" onclick="closeModal('delete-judge-modal')"
                            class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg mr-2">
                        Cancelar
                    </button>
                    <button type="submit"
                            class="bg-red-600 text-white px-4 py-2 rounded-lg">
                        Eliminar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ScrollTop Btn -->
    <button id="scrollTopBtn" class="scroll-btn" onclick="scrollToTop()">
        <i class="fas fa-arrow-up"></i>
    </button>

    <!-- SCRIPTS GENERALES -->
    <script>
        // --- PAGINACIÓN ---
        let currentPage = 1,
            rowsPerPage   = 10,
            judgesRows    = [],
            totalRows     = 0;
        const tableBody = document.getElementById('tableBody');
        document.addEventListener("DOMContentLoaded", () => {
          judgesRows = Array.from(tableBody.querySelectorAll('tr[data-row]'));
          totalRows  = judgesRows.length;
          paginate();
        });
        function paginate() {
          const value = document.getElementById('rowsPerPage').value;
          rowsPerPage = (value === "all") ? totalRows : parseInt(value);
          const totalPages = Math.ceil(totalRows / rowsPerPage) || 1;
          if (currentPage > totalPages) currentPage = totalPages;
          const start = (currentPage - 1) * rowsPerPage;
          const end   = (value === "all") ? totalRows : start + rowsPerPage;
          judgesRows.forEach((r,i) => {
            r.style.display = (i >= start && i < end) ? "" : "none";
          });
          document.getElementById('pageInfo').innerText =
            `Página ${currentPage} de ${totalPages}`;
          document.getElementById('prevBtn').disabled =
            currentPage <= 1;
          document.getElementById('nextBtn').disabled =
            (currentPage >= totalPages || value === "all");
        }
        function changeRowsPerPage() { currentPage = 1; paginate(); }
        function changePage(dir)      { currentPage += dir; paginate(); }

        // --- SCROLL TOP ---
        window.onscroll = () => {
          document.getElementById('scrollTopBtn').style.display =
            (window.scrollY > 200) ? 'block' : 'none';
        };
        function scrollToTop() {
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // --- MODALES ---
        function openModal(id)  { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        // --- HANDLERS DETALLE / EDITAR / ELIMINAR ---
        function openDetailModal(id, cedula, nombres, apellidos, fecha, genero, direccion, telefono, correo) {
          $('#det-cedula').text(cedula);
          $('#det-nombres').text(nombres);
          $('#det-apellidos').text(apellidos);
          $('#det-fecha').text(fecha);
          $('#det-genero').text(genero);
          $('#det-direccion').text(direccion);
          $('#det-telefono').text(telefono);
          $('#det-correo').text(correo);
          openModal('judge-detail-modal');
        }
        function openEditModal(id, cedula, nombres, apellidos, fecha, genero, direccion, telefono, correo) {
          $('#editIdPersona').val(id);
          $('#editCedula').val(cedula);
          $('#editNombres').val(nombres);
          $('#editApellidos').val(apellidos);
          $('#editFechaNacimiento').val(fecha);
          $('#editGenero').val(genero);
          $('#editDireccion').val(direccion);
          $('#editTelefono').val(telefono);
          $('#editCorreoElectronico').val(correo);
          openModal('edit-judge-modal');
        }
        function openDeleteModal(id, nombre) {
          $('#deleteIdPersona').val(id);
          $('#deleteJudgeName').text(nombre);
          openModal('delete-judge-modal');
        }

        // --- INICIALIZACIÓN de jQuery Validate (sin unobtrusive) ---
        $(function(){
          $('#addForm, #editForm').validate({
            errorClass:    'text-red-600 text-xs mt-1',
            errorElement:  'span',
            highlight(el)   { $(el).addClass('border-red-500'); },
            unhighlight(el) { $(el).removeClass('border-red-500'); },
            errorPlacement(error, element) {
              error.insertAfter(element);
            },
            submitHandler(form) {
              form.submit();
            }
          });
        });
              // Inicialización de jQuery Validate para el formulario de creación
        console.log('Inicializando validación en #addForm, validate:', typeof $.fn.validate);
        if (typeof $.fn.validate !== 'function') {
          console.warn('jQuery Validate NO está cargado para #addForm');
        } else {
          $('#addForm').validate({
            errorClass: 'text-red-600 text-xs mt-1',
            errorElement: 'span',
            highlight: e => $(e).addClass('border-red-500'),
            unhighlight: e => $(e).removeClass('border-red-500'),
            errorPlacement: (err, el) => err.insertAfter(el),
            submitHandler: form => form.submit()
          });
        }
    </script>
</body>
</html>
